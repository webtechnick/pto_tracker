#!/usr/bin/env bash

set -e

# Define colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Docker compose command
COMPOSE="docker compose"

# Container name for the app service
APP_CONTAINER="app"

# Display help message
show_help() {
    echo -e "${GREEN}PTO Tracker Docker CLI${NC}"
    echo ""
    echo "Usage: ./pto <command> [arguments]"
    echo ""
    echo "Commands:"
    echo -e "  ${YELLOW}up${NC}         Start all containers in detached mode"
    echo -e "  ${YELLOW}down${NC}       Stop and remove all containers"
    echo -e "  ${YELLOW}restart${NC}    Restart all containers"
    echo -e "  ${YELLOW}start${NC}      Start stopped containers"
    echo -e "  ${YELLOW}stop${NC}       Stop running containers"
    echo -e "  ${YELLOW}ssh${NC}        SSH into the app container"
    echo -e "  ${YELLOW}tinker${NC}     Run Laravel Tinker"
    echo -e "  ${YELLOW}artisan${NC}    Run any Artisan command"
    echo -e "  ${YELLOW}composer${NC}   Run any Composer command"
    echo -e "  ${YELLOW}fresh${NC}      Run migrate:fresh --seed"
    echo -e "  ${YELLOW}test${NC}       Run PHPUnit tests"
    echo -e "  ${YELLOW}build${NC}      Build front-end assets for production"
    echo -e "  ${YELLOW}rebuild${NC}    Rebuild Docker containers"
    echo ""
    echo "Examples:"
    echo "  ./pto up"
    echo "  ./pto artisan make:model Post"
    echo "  ./pto artisan queue:work"
}

# Check if Docker is running
check_docker() {
    if ! docker info > /dev/null 2>&1; then
        echo -e "${RED}Error: Docker is not running${NC}"
        exit 1
    fi
}

# Main command handler
case "$1" in
    up)
        check_docker
        echo -e "${GREEN}Starting containers...${NC}"
        $COMPOSE up -d
        echo -e "${GREEN}Containers started! App available at http://localhost:8000${NC}"
        ;;
    down)
        check_docker
        echo -e "${YELLOW}Stopping and removing containers...${NC}"
        $COMPOSE down
        echo -e "${GREEN}Done!${NC}"
        ;;
    restart)
        check_docker
        echo -e "${YELLOW}Restarting containers...${NC}"
        $COMPOSE restart
        echo -e "${GREEN}Done!${NC}"
        ;;
    start)
        check_docker
        echo -e "${GREEN}Starting containers...${NC}"
        $COMPOSE start
        echo -e "${GREEN}Done!${NC}"
        ;;
    stop)
        check_docker
        echo -e "${YELLOW}Stopping containers...${NC}"
        $COMPOSE stop
        echo -e "${GREEN}Done!${NC}"
        ;;
    ssh)
        check_docker
        echo -e "${GREEN}Entering app container...${NC}"
        $COMPOSE exec $APP_CONTAINER bash
        ;;
    tinker)
        check_docker
        $COMPOSE exec $APP_CONTAINER php artisan tinker
        ;;
    artisan)
        check_docker
        shift 1
        $COMPOSE exec $APP_CONTAINER php artisan "$@"
        ;;
    composer)
        check_docker
        shift 1
        $COMPOSE exec $APP_CONTAINER composer "$@"
        ;;
    fresh)
        check_docker
        echo -e "${YELLOW}Running migrate:fresh --seed...${NC}"
        $COMPOSE exec $APP_CONTAINER php artisan migrate:fresh --seed
        echo -e "${GREEN}Done!${NC}"
        ;;
    test)
        check_docker
        shift 1
        $COMPOSE exec $APP_CONTAINER ./vendor/bin/phpunit "$@"
        ;;
    build)
        check_docker
        echo -e "${YELLOW}Building front-end assets...${NC}"
        $COMPOSE run --rm node npm run prod
        echo -e "${GREEN}Done!${NC}"
        ;;
    rebuild)
        check_docker
        echo -e "${YELLOW}Rebuilding Docker containers...${NC}"
        $COMPOSE down
        $COMPOSE build --no-cache
        $COMPOSE up -d
        echo -e "${GREEN}Containers rebuilt and started! App available at http://localhost:8000${NC}"
        ;;
    help|-h|--help)
        show_help
        ;;
    *)
        show_help
        exit 1
        ;;
esac
